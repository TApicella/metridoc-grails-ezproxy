<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--

    Copyright 2010 Trustees of the University of Pennsylvania Licensed under the
    Educational Community License, Version 2.0 (the "License"); you may
    not use this file except in compliance with the License. You may
    obtain a copy of the License at

    http://www.osedu.org/licenses/ECL-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an "AS IS"
    BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
    or implied. See the License for the specific language governing
    permissions and limitations under the License.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">


    <!-- START: removing binary md5 ids for ip tables -->
    <changeSet id="ezproxy-09" author="Tommy Barker" dbms="mysql,h2">
        <comment>
            deleting the binary key for ip address and adding an integer based one
        </comment>
        <createTable tableName="patron_ip_tmp">
            <column name="id" autoIncrement="true" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="patron_ip" type="varchar(32)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="patron_key" type="binary(16)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>
        <sql>insert into patron_ip_tmp (patron_ip, patron_key) select patron_ip, patron_ip_key from ez_patron_ip</sql>
    </changeSet>

    <changeSet author="Tommy Barker" id="ezproxy-10" dbms="mysql, h2">
        <comment>
            add the patron_ip_id columns to the loading and master tables
        </comment>
        <addColumn tableName="ezproxy_loading">
            <column name="patron_ip_id" type="bigint">
                <constraints nullable="false" unique="true"/>
            </column>
        </addColumn>
        <addColumn tableName="ez_master">
            <column name="patron_ip_id" type="bigint"/>
        </addColumn>
        <sql>update ez_master m, patron_ip_tmp p set m.patron_ip_id = p.id where m.patron_ip_key = p.patron_key</sql>
    </changeSet>

    <changeSet author="Tommy Barker" id="ezproxy-10.5">
        <comment>
            Adding contraints to the master table
        </comment>
        <addNotNullConstraint tableName="ez_master" columnName="patron_ip_id" columnDataType="bigint"/>
    </changeSet>

    <changeSet author="Tommy Barker" id="ezproxy-10.6">
        <comment>
            Adding contraints to the master table
        </comment>
        <createIndex tableName="ez_master" indexName="idx_ez_master_patron_ip_id">
            <column name="patron_ip_id"></column>
        </createIndex>
    </changeSet>

    <changeSet author="Tommy Barker" id="ezproxy-11" dbms="mysql, h2">
        <comment>removes all old binary columns, drops the old ez_patron_ip table and renames the new one</comment>
        <dropColumn tableName="ezproxy_loading" columnName="patron_ip_key"/>
        <dropColumn tableName="ez_master" columnName="patron_ip_key"/>
        <dropTable tableName="ez_patron_ip"/>
        <renameTable oldTableName="patron_ip_tmp" newTableName="ez_patron_ip"/>
        <dropColumn tableName="ez_patron_ip" columnName="patron_key"/>
    </changeSet>
    <!-- END: removing binary md5 ids for ip tables -->

    <!-- START: removing binary md5 ids for patron_id tables -->
    <changeSet id="ezproxy-12" author="Tommy Barker" dbms="mysql,h2">
        <comment>
            creating a temprorary table so we can remove binary hash keys from patron_id tables
        </comment>
        <createTable tableName="patron_id_tmp">
            <column name="id" autoIncrement="true" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="patron_id" type="varchar(32)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="patron_id_key" type="binary(16)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>
        <sql>insert into patron_id_tmp (patron_id, patron_id_key) select patron_id, patron_id_key from ez_patron_id</sql>
    </changeSet>

    <changeSet author="Tommy Barker" id="ezproxy-13" dbms="mysql, h2">
        <comment>
            add the patron_id_id columns to the loading and master tables
        </comment>
        <addColumn tableName="ezproxy_loading">
            <column name="patron_id_id" type="bigint">
                <constraints nullable="false" unique="true"/>
            </column>
        </addColumn>
        <addColumn tableName="ez_master">
            <column name="patron_id_id" type="bigint"/>
        </addColumn>
        <sql>update ez_master m, patron_id_tmp p set m.patron_id_id = p.id where m.patron_id_key = p.patron_id_key</sql>
        <addNotNullConstraint tableName="ez_master" columnName="patron_id_id" columnDataType="bigint"/>
        <createIndex tableName="ez_master" indexName="idx_ez_master_patron_id_id">
            <column name="patron_id_id"></column>
        </createIndex>
    </changeSet>

    <changeSet author="Tommy Barker" id="ezproxy-14" dbms="mysql, h2">
        <comment>removes all old binary columns, drops the old ez_patron_ip table and renames the new one</comment>
        <dropColumn tableName="ezproxy_loading" columnName="patron_id_key"/>
        <dropColumn tableName="ez_master" columnName="patron_id_key"/>
        <dropTable tableName="ez_patron_id"/>
        <renameTable oldTableName="patron_id_tmp" newTableName="ez_patron_id"/>
        <dropColumn tableName="ez_patron_id" columnName="patron_id_key"/>
    </changeSet>

    <!-- END: removing binary md5 ids for patron_id tables -->
</databaseChangeLog>